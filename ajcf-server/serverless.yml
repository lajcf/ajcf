service: ajcf-server

frameworkVersion: ">=1.21.0 <2.0.0"

plugins:
  - serverless-webpack

custom:
  webpack:
    webpackConfig: "webpack.config.js" # Name of webpack configuration file
    includeModules:
      forceExclude:
        - aws-sdk
    packager: "yarn"
  alerts:
    stages:
      - prod
    topics:
      alarm:
        topic: ${self:service}-${opt:stage}-alerts-alarm
        notifications:
          - protocol: email
            endpoint: nicolas.li@hotmail.fr
    alarms:
      - functionErrors
      - functionThrottles

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  region: eu-west-3
  profile: ajcf
  # tracing:
  #   lambda: true
  environment:
    STAGE: ${self:provider.stage}
    BEARER_SECRET_KEY: ${env:BEARER_SECRET_KEY, file(./env.js):env.BEARER_SECRET_KEY}
    GOOGLE_DRIVE_DB_FOLDER_ID: ${env:GOOGLE_DRIVE_DB_FOLDER_ID, file(./env.js):env.GOOGLE_DRIVE_DB_FOLDER_ID}
    GOOGLE_SHEET_API_BEARER_KEY: ${env:GOOGLE_SHEET_API_BEARER_KEY, file(./env.js):env.GOOGLE_SHEET_API_BEARER_KEY}
    GOOGLE_SHEET_MEMBERS_ID: ${env:GOOGLE_SHEET_MEMBERS_ID, file(./env.js):env.GOOGLE_SHEET_MEMBERS_ID}
    GOOGLE_DRIVE_API_BEARER_KEY: ${env:GOOGLE_DRIVE_API_BEARER_KEY, file(./env.js):env.GOOGLE_DRIVE_API_BEARER_KEY}
    GOOGLE_SHEET_LOOKUP: ${env:GOOGLE_SHEET_LOOKUP, file(./env.js):env.GOOGLE_SHEET_LOOKUP}

  memorySize: 3008
  logRetentionInDays: 30
  timeout: 300
  apiGateway:
    minimumCompressionSize: 4096
  # deploymentBucket:
  #   name: ajcf.serverless.${self:provider.region}.deploys
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "secretsmanager:GetSecretValue"
      Resource:
        - "arn:aws:secretsmanager:eu-west-3:071879949813:secret:*"

functions:
  updateDatabaseFromHelloAsso:
    handler: handlers/updateDatabaseFromHelloAsso.handler
    events:
      - schedule: rate(1 hour)
    #reservedConcurrency: 200
#    events:
#      - http:
#          path: endpoint
#          method: post
#          cors:
#            origin: '*' # <-- Specify allowed origin
#            headers: # <-- Specify allowed headers
#              - Content-Type
#              - Authorization
#            allowCredentials: true
#      - http:
#          path: endpoint
#          method: get
#          origin: "*"
#          cors: true
